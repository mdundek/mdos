{{- $appName := .Values.appName -}}

{{- $ftpCredentials := "" }}
{{- if .Values.ftpCredentials }}
  {{- $ftpCredentials = .Values.ftpCredentials }}
{{- end }}

{{- range .Values.components }}
  {{- $appComponentName := lower .name -}}
  {{- $uuid := .uuid }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ $appName }}-{{ lower .name }}
  labels:
    app: {{ $appComponentName }}
    appUuid: {{ $.Values.uuid }}
    compUuid: {{ .uuid }}
    tenantName: {{ $.Values.tenantName }}
spec:
  {{- if .replicaCount }}
  replicas: {{ .replicaCount }}
  {{- else }}
  replicas: 1
  {{- end }}
  selector:
    matchLabels:
      appUuid: {{ $.Values.uuid }}
      compUuid: {{ .uuid }}
      app: {{ $appComponentName }}
      tenantName: {{ $.Values.tenantName }}
  template:

    {{- /* -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=- */}}
    {{- /* -=-=-=-=-=-=-=-=-=-=-=-=-=--=-=-=-= POD =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */}}
    {{- /* -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=- */}}

    metadata:
      labels:
        app: {{ $appComponentName }}
        appUuid: {{ $.Values.uuid }}
        compUuid: {{ .uuid }}
        tenantName: {{ $.Values.tenantName }}
    {{- if $.Values.forceUpdate }}
        date: "{{ now | unixEpoch }}"
    {{- end }}
    spec:
    {{- with .imagePullSecrets }}
      imagePullSecrets:
      {{- toYaml . | nindent 8 }}
    {{- end }}
    {{- if .serviceAccount }}
      serviceAccountName: {{ $appName }}-{{ lower .name }}
    {{- end }}
    {{- with $.Values.podSecurityContext }}
      securityContext:
      {{- toYaml .podSecurityContext | nindent 8 }}
    {{- end }}
    {{- if .nodeSelector }}
      nodeSelector:
        {{ .nodeSelector.label }}: {{ .nodeSelector.value | quote }}
    {{- end }}

    {{- /* -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=- */}}
    {{- /* -=-=-=-=-=-=-=-=-=-=-=-=-=-=- HOSTNAME ALIASES -=-=-=-=-=-=-=-=-=-=-=-=-=-= */}}
    {{- /* -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=- */}}
    {{- if .hostAliases }}
      hostAliases:
      {{- range .hostAliases }}
      - ip: {{ .ip | quote }}
        hostnames:
        {{- range .hostNames }}
        - {{ . | quote }}
        {{- end }}
      {{- end }}
    {{- end }}

    {{- /* -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=- */}}
    {{- /* -=-=-=-=-=-=-=-=-=-=-=-=-=-=-= INIT CONTAINER =-=-=-=-=-=-=-=-=-=-=-=-=-=-= */}}
    {{- /* -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=- */}}

    {{- $srcPaths := "" }}
    {{- $dstPaths := "" }}
    {{- $syncTrigger := "" }}
    {{- $mdosSyncs := "" }}

    {{- range .volumes }}
      {{- if .syncVolume }}
        {{- if $srcPaths }}
          {{-  $volumeSrcPath := printf "%s/%s/%s" $appName "volumes" .name -}}

          {{- $srcPaths = print $srcPaths  ";" $volumeSrcPath -}}
          {{- $dstPaths = print $dstPaths  ";" .mountPath -}}
          {{- $syncTrigger = print $syncTrigger  ";" .trigger -}}
          {{- $mdosSyncs = print $srcPaths  " " .syncVolume -}}
        {{- else }}
          {{-  $volumeSrcPath := printf "%s/%s/%s" $appName "volumes" .name -}}

          {{- $srcPaths = print $volumeSrcPath -}}
          {{- $dstPaths = print .mountPath -}}
          {{- $syncTrigger = print .trigger -}}
          {{- $mdosSyncs = print .syncVolume -}}
        {{- end }}
      {{- end }}
    {{- end }}

    {{- if contains "true" $mdosSyncs }}
      initContainers:
      - name: {{ $appName }}-{{ lower .name }}-init
        image: {{ $.Values.mdosRegistry }}/mdos-mirror-lftp:latest
      {{- if .imagePullPolicy }}
        imagePullPolicy: {{ .imagePullPolicy }}
      {{- else if $.Values.global.imagePullPolicy }}
        imagePullPolicy: {{ $.Values.global.imagePullPolicy }}
      {{- else }}
        imagePullPolicy: IfNotPresent
      {{- end }}
        volumeMounts:
      {{- range .volumes }}
        {{- if .syncVolume }}
          - name: {{ $appName }}-{{ $appComponentName }}-{{ .name }}
            mountPath: "{{ .mountPath }}"
        {{- end }}
      {{- end }}
        command:
          - /usr/local/bin/mirror.sh
        env: 
        - name: SYNC_SOURCE_DIR
          value: {{ $srcPaths }}
        - name: SYNC_TARGET_DIR
          value: {{ $dstPaths }}
        - name: SYNC_TRIGGER
          value: {{ $syncTrigger }}
        - name: FTP_USERNAME
          value: {{ $ftpCredentials.username | quote }}
        - name: FTP_PASSWORD
          value: {{ $ftpCredentials.password | quote }}
        - name: CREATED_AT
          value: {{ $ftpCredentials.createdAt | quote }}
        - name: PROTOCOL
          value: {{ $ftpCredentials.protocol | quote }}
        - name: HOST
          value: {{ $ftpCredentials.host | quote }}
        - name: PORT
          value: {{ $ftpCredentials.port | quote }}
        - name: PARALLEL
          value: "2"
    {{- end }}

    {{- /* -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=- */}}
    {{- /* -=-=-=-=-=-=-=-=-=-=--=--=-=-=-= CONTAINER =-=-=-=-=-=-=--=-=-=-=-=-=-=-=-= */}}
    {{- /* -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=- */}}
      containers:
        - name: {{ $appName }}-{{ lower .name }}
    {{- with $.Values.securityContext }}
          securityContext:
          {{- toYaml .securityContext | nindent 12 }}
    {{- end }}
    {{- if .registry }}
          image: "{{ .registry }}/{{ .image }}:{{ .tag | default $.Chart.AppVersion }}"
    {{- else if not .publicRegistry }}
          image: "{{ $.Values.registry }}/{{ .image }}:{{ .tag | default $.Chart.AppVersion }}"
    {{- else }}
          image: "{{ .image }}:{{ .tag | default $.Chart.AppVersion }}"
    {{- end }}
    {{- if .imagePullPolicy }}
          imagePullPolicy: {{ .imagePullPolicy }}
    {{- else if $.Values.global.imagePullPolicy }}
          imagePullPolicy: {{ $.Values.global.imagePullPolicy }}
    {{- else }}
          imagePullPolicy: IfNotPresent
    {{- end }}
    {{- if .command }}
      {{- with .command }}
          command:
          {{- toYaml . | nindent 12 }}
      {{- end }}
    {{- end }}
    {{- if .commandArgs }}
      {{- with .commandArgs }}
          args:
          {{- toYaml . | nindent 12 }}
      {{- end }}
    {{- end }}
    {{- if .workingDir }}
          workingDir: {{ .workingDir }}
    {{- end }}

    {{- /* -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=- */}}
    {{- /* -=-=-=-=-=-=-=-=-=-=-=-=-= LIVELINESS & READINESS =-=-=-=-=-=-=-=-=-=-=-=-= */}}
    {{- /* -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=- */}}

    {{- if .livenessProbe }}
          livenessProbe:
      {{- if eq .livenessProbe.type "http" }}
            httpGet:
              path: {{ .livenessProbe.path }}
              port: {{ .livenessProbe.port }}
        {{- if .livenessProbe.headers }}
              httpHeaders:
          {{- range .livenessProbe.headers }}
                - name: {{ .name }}
                  value: {{ .value }}
          {{- end }}
        {{- end }}
      {{- else if eq .livenessProbe.type "tcp" }}
            tcpSocket:
              port: {{ .livenessProbe.port }}
      {{- end }}
      {{- if .livenessProbe.initialDelaySeconds }}
            initialDelaySeconds: {{ .livenessProbe.initialDelaySeconds }}
      {{- end }}
      {{- if .livenessProbe.periodSeconds }}
            periodSeconds: {{ .livenessProbe.periodSeconds }}
      {{- end }}
      {{- if .livenessProbe.timeoutSeconds }}
            timeoutSeconds: {{ .livenessProbe.timeoutSeconds }}
      {{- end }}
      {{- if .livenessProbe.successThreshold }}
            successThreshold: {{ .livenessProbe.successThreshold }}
      {{- end }}
      {{- if .livenessProbe.failureThreshold }}
            failureThreshold: {{ .livenessProbe.failureThreshold }}
      {{- end }}
    {{- end }}
  
    {{- if .readinessProbe }}
          readinessProbe:
      {{- if eq .readinessProbe.type "http" }}
            httpGet:
              path: {{ .readinessProbe.path }}
              port: {{ .readinessProbe.port }}
        {{- if .readinessProbe.headers }}
              httpHeaders:
          {{- range .readinessProbe.headers }}
                - name: {{ .name }}
                  value: {{ .value }}
          {{- end }}
        {{- end }}
      {{- else if eq .readinessProbe.type "tcp" }}
            tcpSocket:
              port: {{ .readinessProbe.port }}
      {{- end }}
      {{- if .readinessProbe.initialDelaySeconds }}
            initialDelaySeconds: {{ .readinessProbe.initialDelaySeconds }}
      {{- end }}
      {{- if .readinessProbe.periodSeconds }}
            periodSeconds: {{ .readinessProbe.periodSeconds }}
      {{- end }}
      {{- if .readinessProbe.timeoutSeconds }}
            timeoutSeconds: {{ .readinessProbe.timeoutSeconds }}
      {{- end }}
      {{- if .readinessProbe.successThreshold }}
            successThreshold: {{ .readinessProbe.successThreshold }}
      {{- end }}
      {{- if .readinessProbe.failureThreshold }}
            failureThreshold: {{ .readinessProbe.failureThreshold }}
      {{- end }}
    {{- end }}
       
    {{- /* -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=- */}}
    {{- /* -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= ENV VARS =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */}}
    {{- /* -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=- */}}

          env:

    {{- /* -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= SECRETS =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */}}

    {{- if .secrets }}
      {{- range .secrets }}
        {{- $name := .name }}
        {{- if eq .type "env" }}
          {{- if not .ref }}
            {{- range .entries }}
            - name: {{ .key }}
              valueFrom:
                secretKeyRef:
                  name: {{ $appName }}-{{ $appComponentName }}-{{ $name }}
                  key: {{ .key }}
            {{- end }}
          {{- end }}
          {{- if .ref }}
            {{- $secref := .ref }}
            {{- range .entries }}
            - name: {{ .name }}
              valueFrom:
                secretKeyRef:
                  name: {{ $secref }}
                  key: {{ .key }}
            {{- end }}
          {{- end }}
        {{- end }}
      {{- end }}

      {{- /* -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= GLOBAL SECRETS =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */}}

      {{- if $.Values.global.secrets }}
        {{- range $.Values.global.secrets }}
          {{- $name := .name }}

          {{- /* -=-=-=- ENV VARS -=-=-= */}}

          {{- if eq .type "env" }}
            {{- if not .ref }}
              {{- if .appComp }}
                {{- $rangeKey := .key }}
                {{- range .appComp }}
                  {{- if eq .name $appComponentName }}
            - name: {{ $rangeKey }}
              valueFrom:
                secretKeyRef:
                  name: {{ $appName }}-{{ $appComponentName }}-{{ $name }}
                  key: {{ $rangeKey }}
                  {{- end }}
                {{- end }}
              {{- else }}
            - name: {{ .key }}
              valueFrom:
                secretKeyRef:
                  name: {{ $appName }}-{{ $appComponentName }}-{{ $name }}
                  key: {{ .key }}
              {{- end }}
            {{- end }}
            {{- if .ref }}
              {{- $secref := .ref }}
              {{- range .entries }}
            - name: {{ .name }}
              valueFrom:
                secretKeyRef:
                  name: {{ $secref }}
                  key: {{ .key }}
              {{- end }}
            {{- end }}
          {{- end }}
        {{- end }}
      {{- end }}
    {{- end }}

    {{- /* -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= CONFIG-MAPS =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */}}

    {{- if .configs }}
      {{- range .configs }}
        {{- $name := .name }}
        {{- if eq .type "env" }}
          {{- if not .ref }}
            {{- range .entries }}
            - name: {{ .key }}
              valueFrom:
                configMapKeyRef:
                  name: {{ $appName }}-{{ $appComponentName }}-{{ $name }}
                  key: {{ .key }}
            {{- end }}
          {{- end }}
          {{- if .ref }}
            {{- $cfmref := .ref }}
            {{- range .entries }}
            - name: {{ .name }}
              valueFrom:
                configMapKeyRef:
                  name: {{ $cfmref }}
                  key: {{ .key }}
            {{- end }}
          {{- end }}
        {{- end }}
      {{- end }}

      {{- /* -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= GLOBAL CONFIG-MAPS =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */}}

      {{- if $.Values.global.configs }}
        {{- range $.Values.global.configs }}
          {{- $name := .name }}

          {{- /* -=-=-=- ENV VARS -=-=-= */}}

          {{- if eq .type "env" }}
            {{- if not .ref }}
              {{- if .appComp }}
                {{- $rangeKey := .key }}
                {{- range .appComp }}
                  {{- if eq .name $appComponentName }}
            - name: {{ $rangeKey }}
              valueFrom:
                configMapKeyRef:
                  name: {{ $appName }}-{{ $appComponentName }}-{{ $name }}
                  key: {{ $rangeKey }}
                  {{- end }}
                {{- end }}
              {{- else }}
            - name: {{ .key }}
              valueFrom:
                configMapKeyRef:
                  name: {{ $appName }}-{{ $appComponentName }}-{{ $name }}
                  key: {{ .key }}
              {{- end }}
            {{- end }}
            {{- if .ref }}
              {{- $cfmref := .ref }}
              {{- range .entries }}
            - name: {{ .name }}
              valueFrom:
                configMapKeyRef:
                  name: {{ $cfmref }}
                  key: {{ .key }}
              {{- end }}
            {{- end }}
          {{- end }}
        {{- end }}
      {{- end }}
    {{- end }}

    {{- /* -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=- */}}
    {{- /* -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= PORTS =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=- */}}
    {{- /* -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=- */}}

    {{- if .services }}
      {{- range .services }}
        {{- $svcName := .name }}
        {{- if .ports }}
          ports:
          {{- range .ports }}
          - name: {{ .name }}
            containerPort: {{ .port }}
          {{- end }}
        {{- end }}
      {{- end }}
    {{- end }}

    {{- /* -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=- */}}
    {{- /* -=-=-=-=-=-=-=-=-=-=-==-=-=-=-= RESOURCES =-=-=-=-=-=-=-==-=-=-=-=-=-=-=-=- */}}
    {{- /* -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=- */}}

    {{- if .resources }}
          resources:
          {{- toYaml .resources | nindent 12 }}
    {{- end }}

    {{- /* -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=- */}}
    {{- /* -=-=-=-=-=-=-=-=-=-==-=-=-=-= VOLUME MOUNTS =-=-=-=-=-=-=-==-=-=-=-=-=-=-=- */}}
    {{- /* -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=- */}}

          volumeMounts:

    {{- /* -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= VOLUMES =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */}}

    {{- if .volumes }}
      {{- range .volumes }}
            - name: {{ $appName }}-{{ $appComponentName }}-{{ .name }}
              mountPath: {{ .mountPath }}
        {{- if .subPath }}
              subPath: {{ .subPath }}
        {{- end }}
      {{- end }}
    {{- end }}

    {{- /* -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= CONFIG MAPS =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */}}

    {{- if .configs }}
      {{- range .configs }}
        {{- if eq .type "file" }}
          {{- $mountPath := .mountPath -}}
          {{- $name := lower .name -}}
          {{- range .entries }}
            - name: {{ $appName }}-{{ $appComponentName }}-{{ $name }}
              mountPath: "{{ $mountPath }}/{{ .filename }}"
              subPath: {{ .key | quote }}
          {{- end }}
        {{- end }}
        {{- if eq .type "dir" }}
            - name: {{ $appName }}-{{ $appComponentName }}-{{ lower .name }}
              mountPath: "{{ .mountPath }}"
        {{- end }}
      {{- end }}
    {{- end }}

    {{- /* -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= GLOBAL CONFIG MAPS =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */}}

    {{- if $.Values.global.configs }}
      {{- range $.Values.global.configs }}
        {{- if eq .type "file" }}
          {{- $mountPath := .mountPath -}}
          {{- $config := . }}
          {{- /* -=-=-=-=-=-= CERTAIN APP COMPS ONLY =-=-=-=-=-= */}}
          {{- if .appComp }}
            {{- range .appComp }}
              {{- if eq .name $appComponentName }}
                {{- range $config.entries }}
            - name: {{ $appName }}-{{ $appComponentName }}-{{ $config.name }}
              mountPath: "{{ $mountPath }}/{{ .filename }}"
              subPath: {{ .key | quote }}
                {{- end }}
              {{- end }}
            {{- end }}
          {{- else }}
          {{- /* -=-=-=-=-=-= ALL APP COMPS =-=-=-=-=-= */}}
            {{- range .entries }}
              - name: {{ $appName }}-{{ $appComponentName }}-{{ $config.name }}
                mountPath: "{{ $mountPath }}/{{ .filename }}"
                subPath: {{ .key | quote }}
            {{- end }}
          {{- end }}
        {{- end }}
        {{- if eq .type "dir" }}
          {{- $mountPath := .mountPath -}}
          {{- $config := . }}
          {{- /* -=-=-=-=-=-= CERTAIN APP COMPS ONLY =-=-=-=-=-= */}}
          {{- if .appComp }}
            {{- range .appComp }}
              {{- if eq .name $appComponentName }}
            - name: {{ $appName }}-{{ $appComponentName }}-{{ $config.name }}
              mountPath: "{{ $mountPath }}"
              {{- end }}
            {{- end }}
          {{- else }}
          {{- /* -=-=-=-=-=-= ALL APP COMPS =-=-=-=-=-= */}}
              - name: {{ $appName }}-{{ $appComponentName }}-{{ $config.name }}
                mountPath: "{{ $mountPath }}"
          {{- end }}
        {{- end }}
      {{- end }}
    {{- end }}

    {{- /* -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= SECRETS =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */}}

    {{- if .secrets }}
      {{- range .secrets }}
        {{- if eq .type "file" }}
          {{- $mountPath := .mountPath -}}
          {{- if .entries }}
            {{- $name := lower .name -}}
            {{- range .entries }}
            - name: {{ $appName }}-{{ $appComponentName }}-{{ $name }}
              mountPath: "{{ $mountPath }}/{{ .filename }}"
              subPath: {{ .key | quote }}
            {{- end }}
          {{- end }}  
        {{- end }}
        {{- if eq .type "dir" }}
            - name: {{ $appName }}-{{ $appComponentName }}-{{ lower .name }}
              mountPath: "{{ .mountPath }}"
        {{- end }}
      {{- end }}
    {{- end }}

    {{- /* -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= GLOBAL SECRETS =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */}}

    {{- if $.Values.global.secrets }}
      {{- range $.Values.global.secrets }}
        {{- if eq .type "file" }}
          {{- $mountPath := .mountPath -}}
           {{- $secret := . }}
          {{- /* -=-=-=-=-=-= CERTAIN APP COMPS ONLY =-=-=-=-=-= */}}
          {{- if .appComp }}
            {{- $entries := .entries }}
            {{- range .appComp }}
              {{- if eq .name $appComponentName }}
                {{- range $entries }}
            - name: {{ $appName }}-{{ $appComponentName }}-{{ $secret.name }}
              mountPath: "{{ $mountPath }}/{{ .filename }}"
              subPath: {{ .key | quote }}
                {{- end }}
              {{- end }}
            {{- end }}
          {{- else }}
          {{- /* -=-=-=-=-=-= ALL APP COMPS =-=-=-=-=-= */}}
            {{- range .entries }}
              - name: {{ $appName }}-{{ $appComponentName }}-{{ $secret.name }}
                mountPath: "{{ $mountPath }}/{{ .filename }}"
                subPath: {{ .key | quote }}
            {{- end }}
          {{- end }}
        {{- end }}
        {{- if eq .type "dir" }}
          {{- $mountPath := .mountPath -}}
           {{- $secret := . }}
          {{- /* -=-=-=-=-=-= CERTAIN APP COMPS ONLY =-=-=-=-=-= */}}
          {{- if .appComp }}
            {{- range .appComp }}
              {{- if eq .name $appComponentName }}
            - name: {{ $appName }}-{{ $appComponentName }}-{{ $secret.name }}
              mountPath: "{{ $mountPath }}"
              {{- end }}
            {{- end }}
          {{- else }}
          {{- /* -=-=-=-=-=-= ALL APP COMPS =-=-=-=-=-= */}}
              - name: {{ $appName }}-{{ $appComponentName }}-{{ $secret.name }}
                mountPath: "{{ $mountPath }}"
                subPath: {{ .name | quote }}
          {{- end }}
        {{- end }}
      {{- end }}
    {{- end }}

    {{- /* -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=- */}}
    {{- /* -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= VOLUMES =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=- */}}
    {{- /* -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=- */}}

      volumes:
    {{- if .volumes }}
      {{- range .volumes }}

        {{- /* -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= HOSTPATH =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */}}

        {{- if .hostPath }}
        - name: {{ $appName }}-{{ $appComponentName }}-{{ .name }}
          hostPath:
            path: {{ .hostPath }}
          {{- if .type }}
            type: {{ .type }}
          {{- end }}
        {{- end }}

        {{- /* -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= PVC =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */}}

        {{- if not .hostPath }}
        - name: {{ $appName }}-{{ $appComponentName }}-{{ .name }}
          persistentVolumeClaim:
            claimName: {{ $appName }}-{{ $appComponentName }}-{{ .name }}
        {{- end }}

      {{- end }}
    {{- end }}

    {{- /* -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= CONFIG MAPS =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */}}

    {{- if .configs }}
      {{- range .configs }}
        {{- if or (eq .type "file") (eq .type "dir") }}
        - name: {{ $appName }}-{{ $appComponentName }}-{{ .name }}
          configMap:
          {{- if .ref }}
            name: {{ .ref }}
          {{- else }}
            name: {{ $appName }}-{{ $appComponentName }}-{{ .name }}
          {{- end }}
          {{- if .defaultMode }}
            defaultMode: {{ .defaultMode }}
          {{- end }}
        {{- end }}
      {{- end }}
    {{- end }}

    {{- /* -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= GLOBAL CONFIG MAPS =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */}}

    {{- if $.Values.global.configs }}
      {{- range $.Values.global.configs }}
        {{- if or (eq .type "file") (eq .type "dir") }}
          {{- if .appComp }}
            {{- $config := . }}
            {{- range .appComp }}
              {{- if eq .name $appComponentName }}
        - name: {{ $appName }}-{{ $appComponentName }}-{{ $config.name }}
          configMap:
                {{- if $config.ref }}
            name: {{ $config.ref }}
                {{- else }}
            name: {{ $appName }}-{{ $appComponentName }}-{{ $config.name }}
                {{- end }}
                {{- if $config.defaultMode }}
            defaultMode: {{ $config.defaultMode }}
                {{- end }}
              {{- end }}
            {{- end }}
          {{- else }}
        - name: {{ $appName }}-{{ $appComponentName }}-{{ .name }}
          configMap:
            {{- if .ref }}
            name: {{ .ref }}
            {{- else }}
            name: {{ $appName }}-{{ $appComponentName }}-{{ .name }}
            {{- end }}
            {{- if .defaultMode }}
            defaultMode: {{ .defaultMode }}
            {{- end }}
          {{- end }}
        {{- end }}
      {{- end }}
    {{- end }}

    {{- /* -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= SECRETS =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */}}

    {{- if .secrets }}
      {{- range .secrets }}
        {{- if or (eq .type "file") (eq .type "dir") }}
        - name: {{ $appName }}-{{ $appComponentName }}-{{ .name }}
          secret:
          {{- if .ref }}
            secretName: {{ .ref }}
          {{- else }}
            secretName: {{ $appName }}-{{ $appComponentName }}-{{ .name }}
          {{- end }}
          {{- if .defaultMode }}
            defaultMode: {{ .defaultMode }}
          {{- end }}
        {{- end }}
      {{- end }}
    {{- end }}

    {{- /* -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= GLOBAL SECRETS =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= */}}

    {{- if $.Values.global.secrets }}
      {{- range $.Values.global.secrets }}
        {{- if or (eq .type "file") (eq .type "dir") }}
          {{- if .appComp }}
            {{- $secret := . }}
            {{- range .appComp }}
              {{- if eq .name $appComponentName }}
        - name: {{ $appName }}-{{ $appComponentName }}-{{ .name }}
          secret:
                {{- if $secret.ref }}
            secretName: {{ $secret.ref }}
                {{- else }}
            secretName: {{ $appName }}-{{ $appComponentName }}-{{ $secret.name }}
                {{- end }}
                {{- if $secret.defaultMode }}
            defaultMode: {{ $secret.defaultMode }}
                {{- end }}
              {{- end }}
            {{- end }}
          {{- else }}
        - name: {{ $appName }}-{{ $appComponentName }}-{{ .name }}
          secret:
            {{- if .ref }}
            secretName: {{ .ref }}
            {{- else }}
            secretName: {{ $appName }}-{{ $appComponentName }}-{{ .name }}
            {{- end }}
            {{- if .defaultMode }}
            defaultMode: {{ .defaultMode }}
            {{- end }}
          {{- end }}
        {{- end }}
      {{- end }}
    {{- end }}
{{- end }}