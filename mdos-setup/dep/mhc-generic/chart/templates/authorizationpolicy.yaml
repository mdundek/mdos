{{- $appName := lower $.Values.appName }}
{{- range .Values.components }}
  {{- $appComponentName := lower .name -}}
  {{- $uuid := .uuid -}}
  {{- if .oidc }}
---
apiVersion: security.istio.io/v1beta1
kind: RequestAuthentication
metadata:
  name: {{ $appName }}-{{ $appComponentName }}-ra
  labels:
    app: {{ $appComponentName }}
    appUuid: {{ $.Values.uuid }}
    compUuid: {{ .uuid }}
    tenantName: {{ $.Values.tenantName }}
spec:
  jwtRules:
  - issuer: {{ .oidc.issuer }}
    jwksUri: {{ .oidc.jwksUri }}
  selector:
    matchLabels:
      appUuid: {{ $.Values.uuid }}
      compUuid: {{ $uuid | quote }}
      app: {{ $appComponentName }}
      tenantName: {{ $.Values.tenantName }}
---
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: {{ $appName }}-{{ $appComponentName }}-ap
  labels:
    app: {{ $appComponentName }}
    appUuid: {{ $.Values.uuid }}
    compUuid: {{ .uuid }}
    tenantName: {{ $.Values.tenantName }}
spec:
  action: CUSTOM
  provider:
    name: {{ .oidc.provider | quote }}
  rules:
  - to:
    - operation:
        hosts:
    {{- range .oidc.hosts }}
        - {{ . | quote }}
    {{- end }}

    {{- /* -=-=-=-=-=- EXCLUDE PATHS -=-=-=-=-= */}}
    {{- if .oidc.excludePaths }}
        notPaths:
      {{- range .oidc.excludePaths }}
        - {{ . | quote }}
      {{- end }}
    {{- end }}

    {{- /* -=-=-=-=-=- INCLUDE PATHS -=-=-=-=-= */}}
    {{- if .oidc.paths }}
        paths:
      {{- range .oidc.paths }}
        - {{ . | quote }}
      {{- end }}
    {{- end }}
  selector:
    matchLabels:
      appUuid: {{ $.Values.uuid }}
      compUuid: {{ $uuid }}
      app: {{ $appComponentName }}
      tenantName: {{ $.Values.tenantName }}
  {{- end }}
{{- end }}