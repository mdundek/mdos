{{- if .Values.enabled }}
{{- $appName := lower $.Values.appName }}
{{- range .Values.appComponents }}
{{- $appCompUUID := .mdosAcbmAppCompUUID }}
{{- $appCompName := lower .name }}
{{- if .virtualService }}
{{- range .virtualService }}
---
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  {{- if .name }}
  name: {{ $appName }}-{{ $appCompName }}-{{ .name }}
  {{- else }}
  name: {{ $appName }}-{{ $appCompName }}-{{ .protocol }}
  {{- end }}
  labels:
    {{- include "stateless-helm.labels" $ | nindent 4 }}
    {{- if $.Values.isMdosApp }}
    mdosAcbmAppUUID: {{ $.Values.mdosAcbmAppUUID | quote }}
    mdosAcbmAppCompUUID: {{ $appCompUUID | quote }}
    mdosAcbmAppCompName: {{ $appCompName | quote }}
    mdosBundleName: {{ $.Values.mdosBundleName | quote }}
    {{- end }}
spec:
  hosts:
    {{- range .hosts }}
    - {{ . | quote -}}
    {{- end }}
  gateways:
    - istio-system/{{ .gateway }}

  {{- if eq .protocol "http" }}
  http:
    - name: {{ $appName }}-{{ $appCompName }}-http
    {{- if .httpMatch }}
      match:
        - uri:
            prefix: {{ .httpMatch.prefix }}
          port: {{ .httpMatch.port }}
      rewrite:
        uri: /
    {{- end }}
      route:
      - destination:
          {{- if .openrestyIntercept }}
          port:
            number: 443
          host: mdos-openresty-openresty.openresty.svc.cluster.local
          {{- else }}
          port:
            number: {{ .httpMatch.svcPort }}
          host: {{ $appName }}-{{ $appCompName }}.{{ $.Release.Namespace }}.svc.cluster.local
          {{- end }}
        {{- if .openrestyIntercept }}
        headers:
          request:
            set:
              {{- if .name }}
              kdns: http://{{ $appName }}-{{ $appCompName }}-{{ .name }}.{{ $.Release.Namespace }}.svc.cluster.local:{{ .httpMatch.svcPort }}
              {{- else }}
              kdns: http://{{ $appName }}-{{ $appCompName }}-{{ .protocol }}.{{ $.Release.Namespace }}.svc.cluster.local:{{ .httpMatch.svcPort }}
              {{- end }}
              {{- if .oidcAuth }}
              oidc: true
              {{- end }}
          response:
            set:
              {{- if .name }}
              kdns: http://{{ $appName }}-{{ $appCompName }}-{{ .name }}.{{ $.Release.Namespace }}.svc.cluster.local:{{ .httpMatch.svcPort }}
              {{- else }}
              kdns: http://{{ $appName }}-{{ $appCompName }}-{{ .protocol }}.{{ $.Release.Namespace }}.svc.cluster.local:{{ .httpMatch.svcPort }}
              {{- end }}
              {{- if .oidcAuth }}
              oidc: true
              {{- end }}
        {{- end }}
    {{- range $.serviceLinks }}
    - name: {{ $appName }}-{{ $appCompName }}-service-link
      match:
        - uri:
            prefix: /{{ lower .appName }}
      rewrite:
        uri: /
      route:
      - destination:
          port:
            number: {{ .port }} # which port ??
          host: {{ lower .appName }}.{{ lower .appDomain }}.svc.cluster.local
    {{- end }}
  {{- else if or (eq .protocol "https") (eq .protocol "tls") }}
  tls:
    {{- range .tlsMatchHosts }}
    - match:
        - port: {{ .port }}
          sniHosts: 
            - {{ .host }}
      route:
      - destination:
          {{- if .openrestyIntercept }}
          port:
            number: 443
          host: mdos-openresty-openresty.openresty.svc.cluster.local
          {{- else }}
          port:
            number: {{ .svcPort }}
          host: {{ $appName }}-{{ $appCompName }}.{{ $.Release.Namespace }}.svc.cluster.local
          {{- end }}
        {{- if .openrestyIntercept }}
        headers:
          request:
            set:
              {{- if .name }}
              kdns: https://{{ $appName }}-{{ $appCompName }}-{{ .name }}.{{ $.Release.Namespace }}.svc.cluster.local:{{ .svcPort }}
              {{- else }}
              kdns: https://{{ $appName }}-{{ $appCompName }}-{{ .protocol }}.{{ $.Release.Namespace }}.svc.cluster.local:{{ .svcPort }}
              {{- end }}
              {{- if .oidcAuth }}
              oidc: true
              {{- end }}
          response:
            set:
              {{- if .name }}
              kdns: https://{{ $appName }}-{{ $appCompName }}-{{ .name }}.{{ $.Release.Namespace }}.svc.cluster.local:{{ .svcPort }}
              {{- else }}
              kdns: https://{{ $appName }}-{{ $appCompName }}-{{ .protocol }}.{{ $.Release.Namespace }}.svc.cluster.local:{{ .svcPort }}
              {{- end }}
              {{- if .oidcAuth }}
              oidc: true
              {{- end }}
        {{- end }}
    {{- end }}
  {{- else if eq .protocol "tcp" }}
  tcp:
    {{- range .tcpMatchPorts }}
    - match:
        - port: {{ . }}
      route:
      - destination:
          port:
            number: {{ . }}
          host: {{ $appName }}-{{ $appCompName }}.{{ $.Release.Namespace }}.svc.cluster.local
    {{- end }}
  {{- end }}
{{- end }}
{{- end }}
{{- end }}
{{- end }}
